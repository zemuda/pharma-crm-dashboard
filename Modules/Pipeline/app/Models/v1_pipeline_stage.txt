<?php

namespace Modules\Pipeline\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\DB;
use Modules\Pipeline\Services\TypeConfigService;

class PipelineStage extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = [
        'pipeline_id',
        'name',
        'description',
        'color',
        'order',
        'probability',
        'is_default',
        'meta',
    ];

    protected $casts = [
        'pipeline_id' => 'integer',
        'order' => 'integer',
        'probability' => 'decimal:2',
        'is_default' => 'boolean',
        'meta' => 'array',
    ];

    protected static function booted()
    {
        static::saved(function ($stage) {
            $stage->clearCache();
        });

        static::deleted(function ($stage) {
            $stage->clearCache();
        });
    }

    /**
     * Get the pipeline that owns the stage.
     */
    public function pipeline()
    {
        return $this->belongsTo(Pipeline::class);
    }

    /**
     * Get the next stage in order.
     */
    public function nextStage()
    {
        return $this->pipeline->stages()
            ->where('order', '>', $this->order)
            ->orderBy('order')
            ->first();
    }

    /**
     * Get the previous stage in order.
     */
    public function previousStage()
    {
        return $this->pipeline->stages()
            ->where('order', '<', $this->order)
            ->orderBy('order', 'desc')
            ->first();
    }

    /**
     * Check if this is the first stage.
     */
    public function isFirstStage()
    {
        return $this->order === $this->pipeline->stages()->min('order');
    }

    /**
     * Check if this is the last stage.
     */
    public function isLastStage()
    {
        return $this->order === $this->pipeline->stages()->max('order');
    }

    /**
     * Get entities in this stage for a specific type.
     */
    public function getEntities($typeName)
    {
        $cacheKey = 'pipeline_stage:' . $this->id . ':entities:' . $typeName;

        return Cache::remember($cacheKey, 300, function () use ($typeName) {
            $type = app(TypeConfigService::class)->getTypeConfig($typeName);

            if (!$type) {
                return collect();
            }

            $table = $type->table_name;
            $foreignKey = $type->foreign_key;

            $entityIds = DB::table($table)
                ->where('pipeline_id', $this->pipeline_id)
                ->where('pipeline_stage_id', $this->id)
                ->pluck($foreignKey);

            return $type->findEntities($entityIds->toArray());
        });
    }

    /**
     * Get entity count for a specific type.
     */
    public function getEntityCount($typeName)
    {
        $cacheKey = 'pipeline_stage:' . $this->id . ':entity_count:' . $typeName;

        return Cache::remember($cacheKey, 300, function () use ($typeName) {
            $type = app(TypeConfigService::class)->getTypeConfig($typeName);

            if (!$type) {
                return 0;
            }

            $table = $type->table_name;

            return DB::table($table)
                ->where('pipeline_id', $this->pipeline_id)
                ->where('pipeline_stage_id', $this->id)
                ->count();
        });
    }

    /**
     * Move all entities in this stage to another stage.
     */
    public function moveEntitiesToStage($typeName, $targetStageId)
    {
        $type = app(TypeConfigService::class)->getTypeConfig($typeName);

        if (!$type) {
            return false;
        }

        $table = $type->table_name;

        $updated = DB::table($table)
            ->where('pipeline_id', $this->pipeline_id)
            ->where('pipeline_stage_id', $this->id)
            ->update([
                'pipeline_stage_id' => $targetStageId,
                'stage_changed_at' => now(),
                'updated_at' => now(),
            ]);

        // Clear cache
        $this->clearCache();
        if ($targetStage = self::find($targetStageId)) {
            $targetStage->clearCache();
        }

        return $updated;
    }

    /**
     * Clear stage cache.
     */
    public function clearCache()
    {
        $keys = [
            'pipeline_stage:' . $this->id,
            'pipeline:' . $this->pipeline_id . ':stages',
        ];

        foreach ($keys as $key) {
            Cache::forget($key);
        }

        // Clear pattern cache for entities
        if (config('cache.default') === 'redis') {
            $pattern = 'pipeline_stage:' . $this->id . ':entities:*';
            $keys = Cache::getRedis()->keys($pattern);
            if (!empty($keys)) {
                Cache::getRedis()->del($keys);
            }

            $pattern = 'pipeline_stage:' . $this->id . ':entity_count:*';
            $keys = Cache::getRedis()->keys($pattern);
            if (!empty($keys)) {
                Cache::getRedis()->del($keys);
            }
        }

        // Clear pipeline cache
        if ($this->pipeline) {
            $this->pipeline->clearCache();
        }
    }

    /**
     * Scope a query to order by order column.
     */
    public function scopeOrdered($query)
    {
        return $query->orderBy('order');
    }

    /**
     * Scope a query to only include default stages.
     */
    public function scopeDefault($query)
    {
        return $query->where('is_default', true);
    }

    /**
     * Get cached stage.
     */
    public static function getCached($id)
    {
        $cacheKey = 'pipeline_stage:' . $id;

        return Cache::remember($cacheKey, 3600, function () use ($id) {
            return self::with('pipeline')->find($id);
        });
    }
}
